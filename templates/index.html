<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gestión de Créditos</title>
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="text-center mb-4">Gestión de Créditos</h1>

      <!-- Formulario para registrar Créditos -->
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">Registrar Crédito</div>
        <div class="card-body">
          <form id="formCredito" class="row g-3">
            <div class="col-md-4">
              <input
                type="text"
                id="cliente"
                class="form-control"
                placeholder="Cliente"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                type="number"
                id="monto"
                class="form-control"
                placeholder="Monto"
                step="0.01"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                type="number"
                id="tasa_interes"
                class="form-control"
                placeholder="Tasa interés"
                step="0.01"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                type="number"
                id="plazo"
                class="form-control"
                placeholder="Plazo (meses)"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                type="date"
                id="fecha_otorgamiento"
                class="form-control"
                required
              />
            </div>
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-success">Registrar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Tabla donde se muestran los creditos -->
      <div class="card shadow mb-4">
        <div class="card-header bg-secondary text-white">Lista de Créditos</div>
        <div class="card-body">
          <div class="table-responsive">
            <table
              class="table table-bordered text-center align-middle"
              id="tablaCreditos"
            >
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Monto</th>
                  <th>Tasa Interés</th>
                  <th>Plazo</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Gráfico  -->
      <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
          Distribución de Créditos por Cliente
        </div>
        <div class="card-body">
          <canvas id="grafico"></canvas>
        </div>
      </div>
    </div>

    <!-- Modal para editar crédito -->
    <div
      class="modal fade"
      id="modalEditar"
      tabindex="-1"
      aria-labelledby="modalEditarLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="modalEditarLabel">Editar Crédito</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="formEditar" class="row g-3">
              <input type="hidden" id="editar_id" />
              <div class="col-md-6">
                <input
                  type="text"
                  id="editar_cliente"
                  class="form-control"
                  placeholder="Cliente"
                  required
                />
              </div>
              <div class="col-md-6">
                <input
                  type="number"
                  id="editar_monto"
                  class="form-control"
                  placeholder="Monto"
                  step="0.01"
                  required
                />
              </div>
              <div class="col-md-6">
                <input
                  type="number"
                  id="editar_tasa_interes"
                  class="form-control"
                  placeholder="Tasa interés"
                  step="0.01"
                  required
                />
              </div>
              <div class="col-md-6">
                <input
                  type="number"
                  id="editar_plazo"
                  class="form-control"
                  placeholder="Plazo (meses)"
                  required
                />
              </div>
              <div class="col-md-12">
                <input
                  type="date"
                  id="editar_fecha_otorgamiento"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-warning">
                  Guardar cambios
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Funciones con Javascript -->
    <script>
      const API_URL = "/api/creditos";
      const form = document.getElementById("formCredito");
      const tabla = document.querySelector("#tablaCreditos tbody");
      const ctx = document.getElementById("grafico").getContext("2d");
      let chart;

      // Cargar créditos y actualizar tabla y el gráfico
      async function cargarCreditos() {
        const res = await fetch(API_URL);
        const creditos = await res.json();

        tabla.innerHTML = "";
        const clientes = {};
        creditos.forEach((c) => {
          tabla.innerHTML += `
          <tr>
            <td>${c.id}</td>
            <td>${c.cliente}</td>
            <td>$${c.monto.toFixed(2)}</td>
            <td>${c.tasa_interes}%</td>
            <td>${c.plazo} meses</td>
            <td>${c.fecha_otorgamiento}</td>
            <td>
              <button class="btn btn-warning btn-sm me-1" onclick="abrirModal(${
                c.id
              }, '${c.cliente}', ${c.monto}, ${c.tasa_interes}, ${c.plazo}, '${
            c.fecha_otorgamiento
          }')">Editar</button>
              <button class="btn btn-danger btn-sm" onclick="eliminarCredito(${
                c.id
              })">Eliminar</button>
            </td>
          </tr>
        `;
          clientes[c.cliente] = (clientes[c.cliente] || 0) + c.monto;
        });

        // Actualizar gráfico
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: Object.keys(clientes),
            datasets: [
              {
                label: "Total por cliente",
                data: Object.values(clientes),
                backgroundColor: [
                  "#FF6384",
                  "#36A2EB",
                  "#FFCE56",
                  "#4BC0C0",
                  "#9966FF",
                ],
              },
            ],
          },
        });
      }

      // Registrar nuevo crédito
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const nuevo = {
          cliente: cliente.value,
          monto: parseFloat(monto.value),
          tasa_interes: parseFloat(tasa_interes.value),
          plazo: parseInt(plazo.value),
          fecha_otorgamiento: fecha_otorgamiento.value,
        };
        await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(nuevo),
        });
        form.reset();
        cargarCreditos();
      });

      // Eliminar crédito
      async function eliminarCredito(id) {
        await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        cargarCreditos();
      }

      // Modal de editar
      function abrirModal(id, cliente, monto, tasa, plazo, fecha) {
        document.getElementById("editar_id").value = id;
        document.getElementById("editar_cliente").value = cliente;
        document.getElementById("editar_monto").value = monto;
        document.getElementById("editar_tasa_interes").value = tasa;
        document.getElementById("editar_plazo").value = plazo;
        document.getElementById("editar_fecha_otorgamiento").value = fecha;

        const modal = new bootstrap.Modal(
          document.getElementById("modalEditar")
        );
        modal.show();
      }

      // Guardar cambios del modal
      document
        .getElementById("formEditar")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("editar_id").value;
          const data = {
            cliente: document.getElementById("editar_cliente").value,
            monto: parseFloat(document.getElementById("editar_monto").value),
            tasa_interes: parseFloat(
              document.getElementById("editar_tasa_interes").value
            ),
            plazo: parseInt(document.getElementById("editar_plazo").value),
            fecha_otorgamiento: document.getElementById(
              "editar_fecha_otorgamiento"
            ).value,
          };

          await fetch(`${API_URL}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          cargarCreditos();
          bootstrap.Modal.getInstance(
            document.getElementById("modalEditar")
          ).hide();
        });

      // Cargar créditos al inicio
      cargarCreditos();
    </script>
  </body>
</html>
